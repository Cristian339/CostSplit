<ion-content>
  <div class="recovery-container">
    <div class="recovery-card">
      <div class="logo-container">
        <img src="assets/icon/logo.svg" alt="CostSplit Logo" class="logo">
      </div>

      <h1 class="recovery-title">Recupera tu contraseña</h1>
      <p class="recovery-subtitle" *ngIf="currentStep === 1">Ingresa tu correo electrónico para recibir un código de verificación</p>
      <p class="recovery-subtitle" *ngIf="currentStep === 2">Ingresa el código de verificación enviado a tu correo</p>
      <p class="recovery-subtitle" *ngIf="currentStep === 3">Crea una nueva contraseña</p>

      <form [formGroup]="recoveryForm">
        <!-- Paso 1: Solicitar correo -->
        <div *ngIf="currentStep === 1">
          <div class="input-container">
            <ion-input
              mode="md"
              fill="outline"
              label="Correo electrónico"
              label-placement="floating"
              type="email"
              formControlName="email"
              placeholder="ejemplo@correo.com"
              [errorText]="(email?.invalid && (email?.dirty || email?.touched)) ?
                (email?.errors?.['required'] ? 'El correo electrónico es obligatorio' :
                email?.errors?.['email'] ? 'Ingresa un correo electrónico válido' : '') : ''">
              <ion-icon name="mail-outline" slot="start"></ion-icon>
            </ion-input>
          </div>

          <ion-button
            expand="block"
            color="first"
            (click)="solicitarCodigo()"
            [disabled]="email?.invalid || isLoading"
            class="recovery-button">
            <ion-spinner name="circles" *ngIf="isLoading"></ion-spinner>
            <span *ngIf="!isLoading">Enviar código de verificación</span>
            <span *ngIf="isLoading">Enviando...</span>
          </ion-button>
        </div>

        <!-- Paso 2: Verificar código -->
        <div *ngIf="currentStep === 2">
          <div class="input-container">
            <ion-input
              mode="md"
              fill="outline"
              label="Código de verificación"
              label-placement="floating"
              type="text"
              formControlName="verificationCode"
              placeholder="Ingresa el código de 6 dígitos"
              [errorText]="(verificationCode?.invalid && (verificationCode?.dirty || verificationCode?.touched)) ?
                (verificationCode?.errors?.['required'] ? 'El código es obligatorio' :
                verificationCode?.errors?.['pattern'] ? 'Código inválido' : '') : ''">
              <ion-icon name="key-outline" slot="start"></ion-icon>
            </ion-input>
          </div>

          <ion-button
            expand="block"
            color="first"
            (click)="verificarCodigo()"
            [disabled]="verificationCode?.invalid || isLoading"
            class="recovery-button">
            <ion-spinner name="circles" *ngIf="isLoading"></ion-spinner>
            <span *ngIf="!isLoading">Verificar código</span>
            <span *ngIf="isLoading">Verificando...</span>
          </ion-button>

          <div class="resend-code">
            <p>¿No recibiste el código?</p>
            <ion-button fill="clear" color="first" (click)="solicitarCodigo()">
              Reenviar código
            </ion-button>
          </div>
        </div>

        <!-- Paso 3: Nueva contraseña -->
        <div *ngIf="currentStep === 3">
          <div class="input-container">
            <ion-input
              mode="md"
              fill="outline"
              label="Nueva contraseña"
              label-placement="floating"
              [type]="showPassword ? 'text' : 'password'"
              formControlName="newPassword"
              placeholder="••••••••"
              [errorText]="(newPassword?.invalid && (newPassword?.dirty || newPassword?.touched)) ?
                (newPassword?.errors?.['required'] ? 'La contraseña es obligatoria' :
                newPassword?.errors?.['minlength'] ? 'Mínimo 6 caracteres' : '') : ''">
              <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
              <ion-button fill="clear" size="small" slot="end" (click)="toggleShowPassword()" class="password-toggle">
                <ion-icon [name]="showPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
              </ion-button>
            </ion-input>
          </div>

          <div class="input-container">
            <ion-input
              mode="md"
              fill="outline"
              label="Confirmar contraseña"
              label-placement="floating"
              [type]="showPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="••••••••"
              [errorText]="(confirmPassword?.invalid && (confirmPassword?.dirty || confirmPassword?.touched)) ?
                (confirmPassword?.errors?.['required'] ? 'Confirma tu contraseña' :
                confirmPassword?.errors?.['passwordMismatch'] ? 'Las contraseñas no coinciden' : '') : ''">
              <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            </ion-input>
          </div>

          <ion-button
            expand="block"
            color="first"
            (click)="cambiarContrasenia()"
            [disabled]="newPassword?.invalid || confirmPassword?.invalid || isLoading"
            class="recovery-button">
            <ion-spinner name="circles" *ngIf="isLoading"></ion-spinner>
            <span *ngIf="!isLoading">Cambiar contraseña</span>
            <span *ngIf="isLoading">Cambiando...</span>
          </ion-button>
        </div>
      </form>

      <div class="back-to-login">
        <ion-button fill="clear" color="medium" routerLink="/login">
          <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
          Volver al inicio de sesión
        </ion-button>
      </div>
    </div>
  </div>
</ion-content>
